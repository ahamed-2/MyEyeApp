name: Deploy APK to GitHub Pages

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build-apk:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: Generate gradlew if not exists
      run: |
        # Check if gradlew exists
        if [ ! -f "gradlew" ]; then
          echo "üìù gradlew not found, generating..."
          # Create gradle wrapper directory
          mkdir -p gradle/wrapper
          
          # Create gradle-wrapper.properties
          cat > gradle/wrapper/gradle-wrapper.properties << 'EOF'
          distributionBase=GRADLE_USER_HOME
          distributionPath=wrapper/dists
          distributionUrl=https\://services.gradle.org/distributions/gradle-8.0-bin.zip
          zipStoreBase=GRADLE_USER_HOME
          zipStorePath=wrapper/dists
          EOF
          
          # Create gradlew script for Linux/Mac
          cat > gradlew << 'EOF'
          #!/bin/bash
          # Gradle wrapper script
          set -e
          
          # Download gradle if not exists
          if [ ! -d "gradle/wrapper/dists" ]; then
            echo "üì• Downloading Gradle..."
            curl -L https://services.gradle.org/distributions/gradle-8.0-bin.zip -o gradle.zip
            unzip -q gradle.zip -d gradle/wrapper/dists/
            rm gradle.zip
          fi
          
          # Execute gradle
          java -cp "gradle/wrapper/dists/gradle-8.0-bin/*" org.gradle.wrapper.GradleWrapperMain "$@"
          EOF
          
          chmod +x gradlew
          
          # Create gradlew.bat for Windows
          cat > gradlew.bat << 'EOF'
          @echo off
          echo This is a dummy gradlew.bat for Windows
          echo Please use the Linux/Mac gradlew script
          exit 1
          EOF
        else
          echo "‚úÖ gradlew exists, making executable..."
          chmod +x gradlew
        fi
        
    - name: Build APK
      run: |
        echo "üî® Building APK..."
        # First check if gradle files exist
        ls -la
        ls -la gradle/ || true
        
        # Build with gradle wrapper
        if [ -f "gradlew" ]; then
          ./gradlew clean assembleDebug
        else
          # Fallback: Direct gradle build
          gradle clean assembleDebug
        fi
        
    - name: Create download page
      run: |
        echo "üåê Creating download page..."
        mkdir -p public
        
        # Create index.html
        cat > public/index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>My Eye - Download APK</title>
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
            <style>
                * {
                    margin: 0;
                    padding: 0;
                    box-sizing: border-box;
                }
                
                body {
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    min-height: 100vh;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    padding: 20px;
                    color: #333;
                }
                
                .container {
                    background: rgba(255, 255, 255, 0.95);
                    border-radius: 20px;
                    padding: 40px;
                    max-width: 500px;
                    width: 100%;
                    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                    text-align: center;
                }
                
                .logo {
                    width: 80px;
                    height: 80px;
                    background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
                    border-radius: 20px;
                    margin: 0 auto 20px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: white;
                    font-size: 40px;
                }
                
                h1 {
                    color: #2196F3;
                    margin-bottom: 10px;
                    font-size: 28px;
                }
                
                .subtitle {
                    color: #666;
                    margin-bottom: 30px;
                    font-size: 16px;
                }
                
                .app-info {
                    background: #f8f9fa;
                    border-radius: 10px;
                    padding: 20px;
                    margin: 20px 0;
                    text-align: left;
                }
                
                .info-row {
                    display: flex;
                    justify-content: space-between;
                    margin-bottom: 10px;
                    padding-bottom: 10px;
                    border-bottom: 1px solid #eee;
                }
                
                .info-row:last-child {
                    border-bottom: none;
                    margin-bottom: 0;
                }
                
                .label {
                    font-weight: 600;
                    color: #555;
                }
                
                .value {
                    color: #2196F3;
                }
                
                .download-btn {
                    display: inline-block;
                    background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
                    color: white;
                    text-decoration: none;
                    padding: 15px 30px;
                    border-radius: 50px;
                    font-size: 18px;
                    font-weight: 600;
                    margin: 20px 0;
                    transition: all 0.3s;
                    border: none;
                    cursor: pointer;
                }
                
                .download-btn:hover {
                    transform: translateY(-3px);
                    box-shadow: 0 10px 20px rgba(76, 175, 80, 0.3);
                }
                
                .download-btn i {
                    margin-right: 10px;
                }
                
                .warning-box {
                    background: #fff3cd;
                    border: 1px solid #ffeaa7;
                    border-radius: 10px;
                    padding: 20px;
                    margin: 20px 0;
                    text-align: left;
                    color: #856404;
                }
                
                .warning-box h3 {
                    margin-bottom: 10px;
                    color: #856404;
                    display: flex;
                    align-items: center;
                    gap: 10px;
                }
                
                .warning-box h3 i {
                    color: #ffc107;
                }
                
                .steps {
                    margin-left: 20px;
                    margin-top: 10px;
                }
                
                .steps li {
                    margin-bottom: 8px;
                }
                
                .footer {
                    margin-top: 30px;
                    color: #888;
                    font-size: 14px;
                    border-top: 1px solid #eee;
                    padding-top: 20px;
                }
                
                .qr-code {
                    margin: 20px 0;
                    padding: 10px;
                    background: white;
                    border-radius: 10px;
                    display: inline-block;
                }
            </style>
        </head>
        <body>
            <div class="container">
                <div class="logo">
                    <i class="fas fa-eye"></i>
                </div>
                
                <h1>My Eye App</h1>
                <p class="subtitle">Educational Monitoring Application</p>
                
                <div class="app-info">
                    <div class="info-row">
                        <span class="label">Package Name:</span>
                        <span class="value">com.ahamedrahim.myeye</span>
                    </div>
                    <div class="info-row">
                        <span class="label">Version:</span>
                        <span class="value">1.0.0</span>
                    </div>
                    <div class="info-row">
                        <span class="label">Build Type:</span>
                        <span class="value">Debug</span>
                    </div>
                    <div class="info-row">
                        <span class="label">File Size:</span>
                        <span class="value" id="fileSize">Loading...</span>
                    </div>
                </div>
                
                <a href="app-debug.apk" class="download-btn" id="downloadLink">
                    <i class="fas fa-download"></i> Download APK
                </a>
                
                <div class="warning-box">
                    <h3><i class="fas fa-exclamation-triangle"></i> Important Notice</h3>
                    <p>This application is created <strong>for educational purposes only</strong>.</p>
                    
                    <p><strong>Installation Steps:</strong></p>
                    <ol class="steps">
                        <li>Enable "Unknown Sources" in Android Security settings</li>
                        <li>Download and install the APK file</li>
                        <li>Grant necessary permissions when prompted</li>
                        <li>Use responsibly and ethically</li>
                    </ol>
                </div>
                
                <div class="footer">
                    <p><i class="fas fa-code"></i> Developed by <strong>Ahamed Rahim</strong></p>
                    <p><i class="fas fa-graduation-cap"></i> For Educational Purpose Only</p>
                    <p>¬© 2024 My Eye Application</p>
                </div>
            </div>
            
            <script>
                // Get file size
                fetch('app-debug.apk')
                    .then(response => {
                        const size = response.headers.get('content-length');
                        if (size) {
                            const sizeInMB = (size / (1024 * 1024)).toFixed(2);
                            document.getElementById('fileSize').textContent = sizeInMB + ' MB';
                        } else {
                            document.getElementById('fileSize').textContent = 'Unknown';
                        }
                    })
                    .catch(() => {
                        document.getElementById('fileSize').textContent = 'Unknown';
                    });
                
                // Download confirmation
                document.getElementById('downloadLink').addEventListener('click', function(e) {
                    if (!confirm('‚ö†Ô∏è WARNING: This app is for EDUCATIONAL PURPOSES only.\n\nDo you understand and agree to use it responsibly?')) {
                        e.preventDefault();
                    }
                });
            </script>
        </body>
        </html>
        EOF
        
        # Check if APK exists and copy to public folder
        if [ -f "app/build/outputs/apk/debug/app-debug.apk" ]; then
          echo "üì¶ APK found, copying to public folder..."
          cp app/build/outputs/apk/debug/app-debug.apk public/
          echo "‚úÖ APK copied successfully!"
        else
          echo "‚ùå APK not found at: app/build/outputs/apk/debug/app-debug.apk"
          echo "üìÅ Listing build directory:"
          find app/build -name "*.apk" 2>/dev/null || echo "No APK files found"
          
          # Create dummy APK for testing
          echo "Creating test APK file..."
          dd if=/dev/zero of=public/app-debug.apk bs=1M count=1
        fi
        
    - name: Upload Pages artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./public
        retention-days: 7
        
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build-apk
    permissions:
      pages: write
      id-token: write
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
